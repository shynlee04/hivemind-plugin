---
phase: 01-sdk-foundation-system-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/sdk-context.ts
  - src/index.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Plugin entry destructures client, $, serverUrl, project from PluginInput alongside directory and worktree"
    - "SDK client is stored in module state (not during init) and accessible from all hooks and tools"
    - "Plugin functions fully (14 tools, 4 hooks) when SDK client is unavailable"
  artifacts:
    - path: "src/hooks/sdk-context.ts"
      provides: "Module-level SDK singleton with getters and safe call wrapper"
      exports: ["initSdkContext", "getClient", "getShell", "getServerUrl", "getProject", "withClient", "resetSdkContext"]
    - path: "src/index.ts"
      provides: "Plugin entry point destructuring full PluginInput"
      contains: "client, $: shell, serverUrl, project"
    - path: "src/hooks/index.ts"
      provides: "Barrel export including SDK context"
      contains: "sdk-context"
  key_links:
    - from: "src/index.ts"
      to: "src/hooks/sdk-context.ts"
      via: "initSdkContext() call during plugin init"
      pattern: "initSdkContext\\("
    - from: "src/hooks/sdk-context.ts"
      to: "null fallback"
      via: "getClient() returns null when unavailable"
      pattern: "return _client"
---

<objective>
Wire full SDK surface into plugin entry and create module-level singleton for safe client access.

Purpose: Enable all hooks and tools to access SDK client, BunShell, serverUrl, and project — the foundation for every subsequent phase. Without this, Phase 2+ cannot use showToast, event-driven hooks, or session API.

Output: `src/hooks/sdk-context.ts` (new), updated `src/index.ts`, updated `src/hooks/index.ts`
</objective>

<execution_context>
@/Users/apple/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/apple/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/index.ts
@src/hooks/index.ts
@src/hooks/session-lifecycle.ts
@src/hooks/soft-governance.ts
@src/hooks/tool-gate.ts
@src/hooks/compaction.ts
@node_modules/@opencode-ai/plugin/dist/index.d.ts
@node_modules/@opencode-ai/plugin/dist/shell.d.ts
@node_modules/@opencode-ai/sdk/dist/gen/sdk.gen.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SDK Context Module Singleton</name>
  <files>src/hooks/sdk-context.ts</files>
  <action>
Create `src/hooks/sdk-context.ts` — the module-level singleton that stores all SDK refs safely.

This file MUST be in `src/hooks/` (NOT `src/lib/`) because it imports from `@opencode-ai/plugin`.

**Design pattern:** Module-scoped variables with getter/setter functions (same pattern as reference plugins micode, subtask2, oh-my-opencode).

**Implementation details:**

1. Import types from `@opencode-ai/plugin` and `@opencode-ai/sdk`:
   - `PluginInput` from `@opencode-ai/plugin`
   - `OpencodeClient` from `@opencode-ai/sdk`
   - `BunShell` from `@opencode-ai/plugin` (re-exported from `./shell`)
   - `Project` from `@opencode-ai/sdk`

2. Module-scoped state (all initially null):
   ```typescript
   let _client: OpencodeClient | null = null
   let _shell: BunShell | null = null
   let _serverUrl: URL | null = null
   let _project: Project | null = null
   ```

3. `initSdkContext(input: Pick<PluginInput, 'client' | '$' | 'serverUrl' | 'project'>)`:
   - Stores all 4 refs. Does NOT call any `client.*` methods (deadlock risk per Pitfall 2).
   - Log note: "SDK context initialized" only if client is truthy.

4. Getter functions (all return `T | null`):
   - `getClient()` → returns `_client`
   - `getShell()` → returns `_shell`
   - `getServerUrl()` → returns `_serverUrl`
   - `getProject()` → returns `_project`

5. `withClient<T>(fn: (client: OpencodeClient) => Promise<T>, fallback?: T): Promise<T | undefined>`:
   - If `_client` is null, return `fallback ?? undefined`
   - Otherwise, wrap `fn(_client)` in try/catch
   - On catch: log error to stderr (temporary — Phase 2 will use proper logging), return `fallback ?? undefined`
   - This is the SDK-05 graceful fallback helper that ALL future phases will use

6. `resetSdkContext()`:
   - Sets all 4 refs back to null
   - Used for testing and hot-reload scenarios

7. `isSdkAvailable(): boolean`:
   - Returns `_client !== null`

Add JSDoc comments explaining:
- NEVER call client.* methods from this file (store refs only)
- Hooks/tools call getClient() at execution time, not import time
- This file is the ONLY bridge between SDK types and the rest of the plugin

**Critical constraint:** No side effects during import. No client.* calls. Store refs only.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors.
Verify file exists: `ls src/hooks/sdk-context.ts`
Verify no SDK imports in lib: `! grep -r '@opencode-ai' src/lib/`
  </verify>
  <done>
`src/hooks/sdk-context.ts` exports initSdkContext, getClient, getShell, getServerUrl, getProject, withClient, resetSdkContext, isSdkAvailable. File compiles. No side effects on import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Full PluginInput in Plugin Entry + Update Barrel Export</name>
  <files>src/index.ts, src/hooks/index.ts</files>
  <action>
**Part A — Update `src/index.ts`:**

1. Add import: `import { initSdkContext } from "./hooks/sdk-context.js"`

2. Change the destructuring in plugin entry from:
   ```typescript
   export const HiveMindPlugin: Plugin = async ({
     directory,
     worktree,
   }) => {
   ```
   to:
   ```typescript
   export const HiveMindPlugin: Plugin = async ({
     directory,
     worktree,
     client,
     $: shell,
     serverUrl,
     project,
   }) => {
   ```
   Note: `$` is aliased to `shell` because `$` is awkward as a variable name in non-template contexts.

3. After `const effectiveDir = worktree || directory`, add:
   ```typescript
   // Store SDK refs in module singleton — NEVER call client.* here (deadlock risk)
   // Hooks and tools access via getClient() at execution time
   initSdkContext({ client, $: shell, serverUrl, project })
   ```

4. After the existing log line about initialization, add:
   ```typescript
   await log.info(
     `SDK context: client=${!!client}, shell=${!!shell}, serverUrl=${serverUrl?.href ?? 'none'}`
   )
   ```

5. Update the JSDoc comment on the plugin entry to mention SDK wiring:
   ```
    * Initializes governance layer with:
    *   - SDK context (client, BunShell, serverUrl, project)
    *   - Session lifecycle hook (system prompt injection)
    *   ...
   ```

6. Do NOT change the Hooks return object yet — event hook is added in Plan 02.

7. Do NOT change any hook factory calls — they still receive `(log, effectiveDir, initConfig)`. Hooks will access client via `getClient()` import when they need it (Phase 2+).

**Part B — Update `src/hooks/index.ts`:**

Add export line at the end of the file:
```typescript
export {
  initSdkContext,
  getClient,
  getShell,
  getServerUrl,
  getProject,
  withClient,
  resetSdkContext,
  isSdkAvailable,
} from "./sdk-context.js"
```

**Critical constraints:**
- All 14 tool creation calls remain unchanged (still receive `effectiveDir` only)
- All 4 hook creation calls remain unchanged (still receive `log, effectiveDir, initConfig`)
- No `client.*` method calls anywhere in init function
- Existing tests must still pass — no behavioral change to hooks or tools
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors.
Run `npm test` — all 705+ assertions must still pass (no behavioral change).
Grep check: `grep -c 'initSdkContext' src/index.ts` should return 1.
Grep check: `grep 'client.*serverUrl.*project' src/index.ts` should show the destructuring.
  </verify>
  <done>
`src/index.ts` destructures all 6 PluginInput fields (directory, worktree, client, $, serverUrl, project). SDK refs stored via initSdkContext(). No client.* calls during init. All existing tests pass unchanged. `src/hooks/index.ts` exports all SDK context functions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (type safety)
2. `npm test` passes with 705+ assertions (backward compatibility)
3. `grep -r '@opencode-ai' src/lib/` returns nothing (architecture boundary intact)
4. `grep 'initSdkContext' src/index.ts` returns match (SDK wiring present)
5. `grep 'client.*serverUrl.*project' src/index.ts` returns match (full destructuring)
</verification>

<success_criteria>
- SDK-01: ✅ Plugin entry destructures client, $, serverUrl, project from PluginInput
- SDK-03: ✅ SDK client stored safely via module singleton, not during init (initSdkContext stores refs only)
- SDK-05: ✅ withClient() wraps all client calls in try/catch with fallback (partial — event handler adds more coverage in Plan 02)
- All existing tests pass unchanged
- src/lib/ has zero @opencode-ai imports
</success_criteria>

<output>
After completion, create `.planning/phases/01-sdk-foundation-system-core/01-01-SUMMARY.md`
</output>
