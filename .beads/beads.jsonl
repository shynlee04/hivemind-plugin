{"id":"ralph-tui-hmv3-epic","type":"epic","title":"HiveMind v3.0 Relational Cognitive Engine","description":"Transform HiveMind from a passive 'Flat-File Markdown Logger' into an active Relational Cognitive Engine powered by CQRS, Graph-RAG, the Actor Model, and a strict architectural taxonomy.\n\n## Completed Stories (Phase 1-3)\n- US-001: Graph node Zod schemas ✅\n- US-002: Graph state aggregates ✅\n- US-003: Paths for graph directory ✅\n- US-004: Compaction engine extraction ✅\n- US-005: Session engine extraction ✅\n- US-006: Inspect engine extraction ✅\n- US-007: Brownfield scan extraction ✅\n- US-008: Session split extraction ✅\n- US-009: Tool response helper ✅\n- US-010: Cognitive packer core ✅\n- US-011: Time Machine filter ✅\n- US-012: TTS (Time-To-Stale) filter ✅\n- US-013: XML compression with budget ✅\n- US-014: Graph I/O layer ✅\n- US-015: Wire packer to messages-transform ✅\n- US-016: Implement Pre-Stop Gate checklist ✅\n- US-017: Refactor session-lifecycle to use packer ✅\n\n## Remaining Stories (Phase 4-7)\n- Phase 4: US-018 to US-022 (Graph Migration & Session Swarms)\n- Phase 5: US-023 to US-025 (Tool Consolidation)\n- Phase 6: US-026 to US-031 (Testing & Verification)\n- Phase 7: US-032 to US-050 (OpenTUI Dashboard)\n\n## Architectural Patches Status\n### Completed Patches ✅\n- P0-CONCURRENCY: File mutex added via proper-lockfile (commit 06d2a7f)\n- P0-4-RETRIEVAL: Session-scoped memory retrieval with proximity ranking (commit 1719ff5)\n- P1-ANTIPATTERN: Time Machine compresses false_path to <anti_patterns> (commits 5c8fcd3, 9658d78)\n- P1-ID-ECHO: Tools echo generated UUID in response (commit 965f8c4)\n- P1-BUDGET: XML budget scales to 12% context window ~15360 chars (commit fff5e01)\n\n### Open Patches\n- P0-RUNTIME: Dashboard spawns as detached child process, uses cmd_queue.jsonl for IPC\n- P0-VALIDATION: Read-time Zod uses .catch(), quarantines orphans to graph/orphans.json\n- P1-AMNESIA: 80% splitter captures last 6 messages as <recent_dialogue>","status":"open","priority":1,"external_ref":"prd:./docs/plans/prd-hivemind-v3-relational-engine-2026-02-16.md","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T16:30:00.000Z"}
{"id":"ralph-tui-015","type":"task","title":"US-015: Wire packer to messages-transform","description":"As the system, I want packed XML injected into every user message so the agent has pristine context.\n\n## Acceptance Criteria\n- [x] In messages-transform.ts, call packCognitiveState()\n- [x] Inject as synthetic: true part at START (prepend)\n- [x] Keep existing checklist as second synthetic part (append)\n\n## Quality Gates\n- [x] npm test passes (82/84 tests)\n- [x] npx tsc --noEmit passes\n\n## Completion Evidence\n- Commit: c37bf77 (2026-02-16)\n- Line 230: packCognitiveState(directory) called\n- Line 231: prependSyntheticPart() for XML injection\n- Tests: 17/17 messages-transform tests pass\n\n## Dependencies\n- Depends on: US-010 (cognitive-packer), US-014 (graph-io)","status":"complete","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T16:30:00.000Z"}
{"id":"ralph-tui-016","type":"task","title":"US-016: Implement Pre-Stop Gate checklist","description":"As the system, I want to force the agent to verify state before stopping.\n\n## Acceptance Criteria\n- [x] Checklist items derived from trajectory.json active tasks\n- [x] Items: hierarchy updated, artifacts saved, commit threshold met\n- [x] Checklist injected as synthetic: true part at END\n- [x] Format: <system-reminder>BEFORE completing your turn...</system-reminder>\n\n## Quality Gates\n- [x] npm test passes (82/84 tests)\n- [x] npx tsc --noEmit passes\n\n## Completion Evidence\n- Commit: 0e309db (2026-02-16)\n- Dual-read pattern: graph/tasks.json primary, tasks.json fallback\n- Lines 262-296: trajectory.json active_task_ids filtering\n- buildChecklist() function with MAX_CHECKLIST_CHARS constant\n\n## Dependencies\n- Depends on: US-015 (packer wired to messages-transform)","status":"complete","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T16:30:00.000Z"}
{"id":"ralph-tui-017","type":"task","title":"US-017: Refactor session-lifecycle to use packer","description":"As a developer, I want session-lifecycle.ts reduced from 586 lines to ≤200 by using the packer.\n\n## Acceptance Criteria\n- [x] Replace ad-hoc section assembly with packCognitiveState() call\n- [x] Keep: bootstrap block (first 2 turns), setup guidance, governance signals\n- [x] Move: brownfield detection, framework conflict routing → src/lib/onboarding.ts\n- [x] File reduced to ≤200 lines\n\n## Quality Gates\n- [x] npm test passes (82/84 tests)\n- [x] npx tsc --noEmit passes\n\n## Completion Evidence\n- Line count: 165 lines (target: ≤200) ✅\n- packCognitiveState() at line 75 with 40% budget allocation\n- Extraction: onboarding.ts (detectBrownfield, generateReadFirstBlock, isCleanSession, handleStaleSession)\n- Extraction: session-governance.ts (buildGovernanceSignals)\n- Code-review verdict: PASS (all 4 AC met, low coupling, high cohesion)\n\n## Dependencies\n- Depends on: US-010 (cognitive-packer)","status":"complete","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T16:30:00.000Z"}
{"id":"ralph-tui-018","type":"task","title":"US-018: Build graph migration script","description":"As the system, I want one-time auto-migration from flat files to graph structure.\n\n## Acceptance Criteria\n- [ ] Create src/lib/graph-migrate.ts\n- [ ] migrateToGraph(directory) triggers on first hook if graph/ missing\n- [ ] Migrate: brain.json hierarchy → trajectory.json\n- [ ] Migrate: tasks.json flat → graph/tasks.json with parent_phase_id FK\n- [ ] Migrate: mems.json flat → graph/mems.json with staleness_stamp, type: insight, origin_task_id: null\n- [ ] Create empty graph/plans.json\n- [ ] Preserve old files as .bak backups\n\n## Architectural Patches (P0)\n- [ ] Generate default 'Legacy Context' PhaseNode UUID for migrated tasks\n- [ ] All migrated tasks assigned to this parent_phase_id (FK validation)\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-001 (schemas), US-002 (state schemas), US-014 (graph-io)","status":"open","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-019","type":"task","title":"US-019: Implement dual-read backward compat","description":"As the system, I want graph-aware functions to fall back to legacy paths during migration.\n\n## Acceptance Criteria\n- [ ] All graph-aware functions check graph/ first\n- [ ] Fall back to state/ and memory/ if graph missing\n- [ ] Log migration status on each fallback\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-018 (graph migration script)","status":"open","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-020","type":"task","title":"US-020: Implement 80% session splitter","description":"As the system, I want to split sessions at 80% context capacity with pristine handoff.\n\n## Acceptance Criteria\n- [ ] Create src/lib/session-swarm.ts\n- [ ] Monitor session token pressure via SDK\n- [ ] At 80%: call packCognitiveState() for export\n- [ ] Call client.session.create() with packed XML as Turn 0\n- [ ] Save export to sessions/archive/splits/\n\n## Architectural Patches (P1 - CRITICAL)\n- [ ] Extract last 6 conversational messages (Short-Term Memory)\n- [ ] Inject: [XML Graph State] + <recent_dialogue>[Messages]</recent_dialogue> as Turn 0\n- [ ] Prevent mid-thought amnesia\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-010 (cognitive-packer), US-008 (session-split)","status":"open","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-021","type":"task","title":"US-021: Implement headless researcher swarms","description":"As the system, I want to spawn background sub-sessions for research tasks.\n\n## Acceptance Criteria\n- [ ] spawnHeadlessResearcher(client, parentId, prompt) function\n- [ ] Uses noReply: true to force background execution\n- [ ] Commands sub-agent to save findings to graph/mems.json with origin_task_id\n- [ ] Metadata tracked in sessions/active/swarms/\n\n## Architectural Patches (P0 - CRITICAL)\n- [ ] File mutex REQUIRED in graph-io.ts for concurrent writes\n- [ ] Use proper-lockfile or append-only JSONL for mems.json\n- [ ] Prevent TOCTOU race conditions\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-020 (session-swarm), US-014 (graph-io)","status":"open","priority":3,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-022","type":"task","title":"US-022: Wire trajectory write-through in tools","description":"As the system, I want tools to update trajectory.json on hierarchy changes.\n\n## Acceptance Criteria\n- [ ] declare_intent → sets trajectory.active_plan_id, clears phase/task\n- [ ] map_context(trajectory) → updates intent shift stamp\n- [ ] map_context(tactic/action) → updates active_phase_id / active_task_ids\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-014 (graph-io), US-018 (graph migration)","status":"open","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-009-patch","type":"task","title":"PATCH-US-009: Add ID echo to tool responses","description":"As a developer, I want tools to return the generated UUID when creating entities.\n\n## Acceptance Criteria (P1)\n- [ ] Export toSuccessOutput(entityId?: string) in tool-response.ts\n- [ ] Export toErrorOutput() in tool-response.ts\n- [ ] Tools that create nodes MUST echo UUID back to LLM\n- [ ] LLM can then chain relational FKs\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-009 (tool-response.ts exists)","status":"complete","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z","completion_evidence":{"commit":"965f8c4","summary":"toSuccessOutput() returns JSON with entity_id field for FK chaining","verified_at":"2026-02-16T18:00:00.000Z"}}
{"id":"ralph-tui-014-patch","type":"task","title":"PATCH-US-014: Add concurrency safety to graph-io","description":"As a developer, I want graph-io.ts to handle concurrent writes safely.\n\n## Acceptance Criteria (P0 - STOP SHIP)\n- [x] Add proper-lockfile dependency to package.json\n- [x] Wrap all save* and add* operations with file mutex\n- [x] OR: Convert mems.json and tasks.json to append-only JSONL format\n- [x] Test: concurrent writes do not cause data loss\n\n## Quality Gates\n- [x] npm test passes\n- [x] npx tsc --noEmit passes\n\n## Dependencies\n- Blocks: US-021, US-048, all concurrent write scenarios","status":"complete","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T18:00:00.000Z","completion_evidence":{"commit":"06d2a7f","summary":"Added proper-lockfile to graph-io.ts for file mutex on concurrent writes","verified_at":"2026-02-16T18:00:00.000Z"}}
{"id":"ralph-tui-011-patch","type":"task","title":"PATCH-US-011: Preserve false_path as anti-patterns","description":"As a developer, I want false_path nodes compressed, not dropped.\n\n## Acceptance Criteria (P1)\n- [ ] Do NOT silently drop type: false_path memories\n- [ ] Compress to <anti_patterns><avoid task=\"UUID\">...</avoid></anti_patterns>\n- [ ] Cap at 500 characters\n- [ ] Prevent amnesia loops\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-011 (Time Machine filter)","status":"complete","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z","completion_evidence":{"commit":"5c8fcd3, 9658d78","summary":"Added <anti_patterns> section in cognitive-packer.ts to preserve false_path instead of dropping","verified_at":"2026-02-16T18:00:00.000Z"}}
{"id":"ralph-tui-013-patch","type":"task","title":"PATCH-US-013: Scale XML budget dynamically","description":"As a developer, I want the XML budget to scale with context window.\n\n## Acceptance Criteria (P1)\n- [ ] Budget = 10-15% of active model's context window\n- [ ] Default: ~15000 characters (was 2000)\n- [ ] Configurable via config.json\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-013 (XML compression)","status":"complete","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z","completion_evidence":{"commit":"fff5e01","summary":"Budget scales to 12% of context window (~15360 chars) instead of fixed 2000 chars","verified_at":"2026-02-16T18:00:00.000Z"}}
{"id":"ralph-tui-023","type":"task","title":"US-023: Wire 6 canonical hivemind tools","description":"As a developer, I want the 6 unified hivemind-*.ts tools wired into index.ts.\n\n## Acceptance Criteria\n- [ ] src/index.ts registers 6 tools (was 10)\n- [ ] Tools: hivemind_session, hivemind_inspect, hivemind_memory, hivemind_anchor, hivemind_hierarchy, hivemind_cycle\n- [ ] All 6 tools slimmed to ≤100 lines (business logic in libs)\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: Phase 1-3 complete","status":"open","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-024","type":"task","title":"US-024: Delete 13 old tool files","description":"As a developer, I want dead tool files removed to eliminate confusion.\n\n## Acceptance Criteria\n- [ ] Delete: declare-intent.ts, map-context.ts, compact-session.ts, scan-hierarchy.ts, save-anchor.ts, think-back.ts, save-mem.ts, recall-mems.ts, hierarchy.ts, export-cycle.ts, check-drift.ts, list-shelves.ts, self-rate.ts\n- [ ] Update src/tools/index.ts to export only 6 canonical tools\n- [ ] Update classifyTool() in detection.ts to recognize new names\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-023","status":"open","priority":2,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-025","type":"task","title":"US-025: Update documentation","description":"As a user, I want documentation to reflect the new tool structure.\n\n## Acceptance Criteria\n- [ ] Update AGENTS.md with new tool names\n- [ ] Update README.md with new tool list\n- [ ] Update CLI help text\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-023, US-024","status":"open","priority":3,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-032","type":"task","title":"US-032: Migrate from Ink to OpenTUI","description":"As a developer, I want to migrate the dashboard from Ink to OpenTUI for OpenCode ecosystem integration.\n\n## Acceptance Criteria\n- [ ] Add dependencies: @opentui/react, @opentui/core, react (>=19.0.0)\n- [ ] Remove Ink dependencies from package.json\n- [ ] Bun runtime required - add engines: { bun: >=1.0.0 }\n- [ ] Update TypeScript config with jsxImportSource: @opentui/react\n- [ ] Create src/dashboard/opentui/Dashboard.tsx\n- [ ] Entry point: createCliRenderer() from @opentui/core, createRoot(renderer) from @opentui/react\n- [ ] CRITICAL: Use renderer.destroy() to exit - NEVER process.exit()\n\n## Architectural Patches (P0 - CRITICAL)\n- [ ] Launch via child_process.spawn('bun', ..., { detached: true })\n- [ ] Isolate Bun runtime from Node.js SDK runtime\n- [ ] Prevent cross-platform EBUSY locks\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-010, US-014","status":"open","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-038-patch","type":"task","title":"PATCH-US-038: Dashboard IPC boundary","description":"As a developer, I want the Bun dashboard to communicate safely with Node.js SDK.\n\n## Acceptance Criteria (P0 - CRITICAL)\n- [ ] Dashboard MUST NOT call graph-io.ts mutating functions directly\n- [ ] UI mutations written to .hivemind/system/cmd_queue.jsonl (append-only)\n- [ ] Node.js hook polls/reads cmd_queue.jsonl to process mutations\n- [ ] Strict unidirectional data flow\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-032, US-010","status":"open","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
{"id":"ralph-tui-026","type":"task","title":"US-026: Create graph schema tests","description":"As a developer, I want unit tests for Zod schema validation.\n\n## Acceptance Criteria\n- [ ] Create tests/graph-nodes.test.ts\n- [ ] Test: valid/invalid nodes\n- [ ] Test: FK constraints (orphan rejection)\n\n## Architectural Patches (P0)\n- [ ] Test: Read validation uses .catch() - does NOT throw on orphan\n- [ ] Test: Orphan nodes quarantined to graph/orphans.json\n\n## Quality Gates\n- [ ] npm test passes\n- [ ] npx tsc --noEmit passes\n\n## Dependencies\n- Depends on: US-001 (graph-nodes.ts schemas)","status":"open","priority":1,"parent_id":"ralph-tui-hmv3-epic","created_at":"2026-02-16T08:30:00.000Z","updated_at":"2026-02-16T08:30:00.000Z"}
